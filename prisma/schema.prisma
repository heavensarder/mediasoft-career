generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  isSystem Boolean @default(false)
  jobs     Job[]
}

model JobType {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  isSystem Boolean @default(false)
  jobs     Job[]
}

model Location {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  isSystem Boolean @default(false)
  jobs     Job[]
}

model Job {
  id           Int         @id @default(autoincrement())
  title        String
  description  String      @db.Text
  departmentId Int?
  department   Department? @relation(fields: [departmentId], references: [id])
  typeId       Int?
  jobType      JobType?    @relation(fields: [typeId], references: [id])
  locationId   Int?
  location     Location?   @relation(fields: [locationId], references: [id])
  expiryDate   DateTime?
  slug         String      @unique @default(cuid()) // Temporary default using cuid to pass migration, can be updated later.
  salaryRange  String?
  status       String      @default("Active") // Active, On Hold, Expired, Closed
  isDraft      Boolean     @default(false)
  positionFilled Int         @default(0)
  views        Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  applications Application[]
}

model Application {
  id             Int      @id @default(autoincrement())
  jobId          Int
  job            Job      @relation(fields: [jobId], references: [id])
  fullName       String
  nid            String
  dob            DateTime
  gender         String
  mobile         String
  email          String
  experience     String
  currentSalary  String?
  expectedSalary String?
  education      String   // Latest Education Qualification
  source         String   // Recruitment Source
  objective      String   @db.Text
  photo          String?  // Path to photo
  resume         String?  // Path to resume
  achievements   String?  @db.Text
  message        String?  @db.Text
  linkedin       String?
  facebook       String?
  portfolio      String?
  status         String   @default("New") // New, Viewed, Shortlisted, Interview, Rejected, Selected
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  dynamicData    Json?    // Stores values for custom dynamic fields
  interviewDate  DateTime? // Interview date and time
  interviewEnded Boolean  @default(false) // When true, removes from Interview Panel but keeps status
  interviewMarking InterviewMarking?
  
  // Assigned interviewers for this applicant (many-to-many)
  assignedInterviewers ApplicationAssignment[]
}

// Join table for many-to-many relationship between Application and InterviewAdmin
model ApplicationAssignment {
  id              Int            @id @default(autoincrement())
  applicationId   Int
  application     Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewerId   Int
  interviewer     InterviewAdmin @relation(fields: [interviewerId], references: [id], onDelete: Cascade)
  assignedAt      DateTime       @default(now())
  
  @@unique([applicationId, interviewerId])
}

// Interview Admin users with restricted access
model InterviewAdmin {
  id                    Int                     @id @default(autoincrement())
  name                  String
  email                 String                  @unique
  password              String
  role                  String                  @default("interview_admin")
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  markingPermissions    MarkingPermission?
  marks                 InterviewMarking[]
  assignedApplications  ApplicationAssignment[]
}


// Interview marking scores per applicant
model InterviewMarking {
  id              Int              @id @default(autoincrement())
  applicationId   Int              @unique
  application     Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  writtenExam     Int?             // 0-30
  technicalViva   Int?             // 0-10
  projectRating   Int?             // 1-5 stars
  // Exclusion flags - if true, section is excluded from total score
  excludeWritten  Boolean          @default(false)
  excludeTechnical Boolean         @default(false)
  excludeProject  Boolean          @default(false)
  markedById      Int?
  markedBy        InterviewAdmin?  @relation(fields: [markedById], references: [id], onDelete: SetNull)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// Granular permissions for marking sections
model MarkingPermission {
  id                Int             @id @default(autoincrement())
  interviewAdminId  Int             @unique
  interviewAdmin    InterviewAdmin  @relation(fields: [interviewAdminId], references: [id], onDelete: Cascade)
  writtenExam       Boolean         @default(false)
  technicalViva     Boolean         @default(false)
  project           Boolean         @default(false)
}

model FormField {
  id          Int      @id @default(autoincrement())
  label       String
  name        String   @unique
  type        String   // text, number, date, file, textarea, select
  required    Boolean  @default(false)
  placeholder String?
  order       Int      @default(0)
  options     String?  // For select/radio types (comma separated or JSON)
  isSystem    Boolean  @default(false) // True for core fields (Name, Email, etc.)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique // e.g., 'company_logo', 'company_name'
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MailConfig {
  id            Int      @id @default(autoincrement())
  senderEmail   String
  clientId      String   @db.Text
  clientSecret  String   @db.Text
  refreshToken  String   @db.Text
  
  // Notification Template (Sent to Admin/Receiver)
  notificationSubject String?
  notificationBody    String? @db.Text

  // Auto Reply
  isAutoReplyEnabled Boolean @default(false)
  autoReplyTemplateId Int?
  autoReplyTemplate   MailTemplate? @relation("AutoReplyTemplate", fields: [autoReplyTemplateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MailTemplate {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  subject   String
  body      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  mailConfigs MailConfig[] @relation("AutoReplyTemplate")
}

model PageSeo {
  id           Int      @id @default(autoincrement())
  page         String   @unique // e.g., "home", "job_details", "global"
  title        String?  // Title template
  description  String?  @db.Text
  keywords     String?  @db.Text
  ogImage      String?
  ogTitle      String?  // Social media title override
  ogDescription String? @db.Text // Social media description override
  jsonLd       String?  @db.Text // Custom Structured Data (JSON-LD)
  canonicalUrl String?  // Canonical URL for duplicate content
  robots       String?  // e.g., "index,follow", "noindex,nofollow"
  updatedAt    DateTime @updatedAt
}

model SliderImage {
  id        Int      @id @default(autoincrement())
  url       String
  createdAt DateTime @default(now())
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  userType    String   // 'admin' | 'interview_admin'
  userName    String
  userEmail   String
  action      String   // e.g., 'CREATE_JOB', 'UPDATE_APPLICATION', 'CHANGE_SETTINGS'
  entityType  String?  // e.g., 'Job', 'Application', 'Settings'
  entityId    Int?     // ID of the affected entity
  entityName  String?  // Human-readable name (e.g., job title)
  details     String?  @db.Text  // JSON or additional details
  ipAddress   String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([userEmail])
}

